<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elenco Iscritti</title>
  <style>
    body { background: #1a1a1a; color: #f3f3f3; font-family: Arial, sans-serif; }
    main { max-width: 900px; margin: 2em auto; background: #23272b; padding: 2em; border-radius: 12px; box-shadow: 0 2px 16px rgba(0,0,0,0.15); }
    h1 { color: #60a5fa; }
    table { width: 100%; border-collapse: collapse; margin-top: 2em; }
    th, td { padding: 0.7em; border-bottom: 1px solid #2563eb; text-align: left; }
    th { background: #181a1b; color: #60a5fa; }
    tr:last-child td { border-bottom: none; }
    #firebase-status { margin-bottom:1em; font-weight:bold; }
    .action-icons { display: flex; gap: 0.5em; }
    .action-icons button { background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0.3em; transition: transform 0.2s; }
    .action-icons button:hover { transform: scale(1.2); }
    .edit-btn { color: #60a5fa; }
    .delete-btn { color: #f87171; }
    .edit-input { background: #181a1b; color: #f3f3f3; border: 1px solid #2563eb; padding: 0.3em; border-radius: 4px; width: 100%; }
  </style>
</head>
<body>
<main>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
    <h1 style="margin: 0;">Elenco Iscritti</h1>
    <button onclick="window.location.href='index.html'" style="padding: 0.7em 1.5em; background: #2563eb; color: #fff; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; font-weight: bold; transition: background 0.2s;">
      ‚Üê Indietro
    </button>
  </div>
  <div id="firebase-status"></div>
  <table id="students-table">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Cognome</th>
        <th>Anno di nascita</th>
        <th>Telefono</th>
        <th>Email</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody>
      <!-- Students will be listed here -->
    </tbody>
  </table>
</main>

<!-- Firebase SDKs -->
<script src="firebase-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
<script>
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const statusDiv = document.getElementById('firebase-status');
  const tableBody = document.querySelector('#students-table tbody');

  function deleteStudent(docId, row) {
    if (!confirm('Sei sicuro di voler eliminare questo iscritto?')) return;
    
    db.collection("iscrizioni").doc(docId).delete()
      .then(() => {
        row.remove();
        statusDiv.textContent = "‚úÖ Iscritto eliminato con successo.";
        statusDiv.style.color = "#22c55e";
      })
      .catch((error) => {
        statusDiv.textContent = "‚ùå Errore nell'eliminazione: " + error.message;
        statusDiv.style.color = "#f87171";
      });
  }

  function editStudent(docId, row, data) {
    const cells = row.querySelectorAll('td');
    const fields = ['FirstName', 'LastName', 'BirthYear', 'Phone', 'Email'];
    
    // Convert cells to editable inputs
    fields.forEach((field, index) => {
      const value = data[field] || '';
      cells[index].innerHTML = `<input type="text" class="edit-input" value="${value}" data-field="${field}">`;
    });

    // Replace action buttons with save/cancel
    cells[5].innerHTML = `
      <div class="action-icons">
        <button class="save-btn" title="Salva">üíæ</button>
        <button class="cancel-btn" title="Annulla">‚ùå</button>
      </div>
    `;

    cells[5].querySelector('.save-btn').onclick = function() {
      const updates = {};
      row.querySelectorAll('.edit-input').forEach(input => {
        updates[input.dataset.field] = input.value;
      });

      db.collection("iscrizioni").doc(docId).update(updates)
        .then(() => {
          statusDiv.textContent = "‚úÖ Iscritto aggiornato con successo.";
          statusDiv.style.color = "#22c55e";
          // Restore display mode
          fields.forEach((field, index) => {
            cells[index].textContent = updates[field] || '-';
          });
          cells[5].innerHTML = `
            <div class="action-icons">
              <button class="edit-btn" title="Modifica">‚úèÔ∏è</button>
              <button class="delete-btn" title="Elimina">üóëÔ∏è</button>
            </div>
          `;
          cells[5].querySelector('.edit-btn').onclick = () => editStudent(docId, row, updates);
          cells[5].querySelector('.delete-btn').onclick = () => deleteStudent(docId, row);
        })
        .catch((error) => {
          statusDiv.textContent = "‚ùå Errore nell'aggiornamento: " + error.message;
          statusDiv.style.color = "#f87171";
        });
    };

    cells[5].querySelector('.cancel-btn').onclick = function() {
      // Restore original values
      fields.forEach((field, index) => {
        cells[index].textContent = data[field] || '-';
      });
      cells[5].innerHTML = `
        <div class="action-icons">
          <button class="edit-btn" title="Modifica">‚úèÔ∏è</button>
          <button class="delete-btn" title="Elimina">üóëÔ∏è</button>
        </div>
      `;
      cells[5].querySelector('.edit-btn').onclick = () => editStudent(docId, row, data);
      cells[5].querySelector('.delete-btn').onclick = () => deleteStudent(docId, row);
    };
  }

  // Check authentication state
  auth.onAuthStateChanged(user => {
    if (!user) {
      statusDiv.textContent = "‚ùå Accesso negato. Effettua il login.";
      statusDiv.style.color = "#f87171";
      tableBody.innerHTML = '<tr><td colspan="6">Devi effettuare il login per visualizzare gli iscritti.</td></tr>';
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 2000);
      return;
    }

    // User is logged in, fetch students
    db.collection("iscrizioni").get()
      .then((querySnapshot) => {
        statusDiv.textContent = "‚úÖ Connessione ok.";
        statusDiv.style.color = "#22c55e";
        if (querySnapshot.empty) {
          tableBody.innerHTML = '<tr><td colspan="6">Nessun iscritto trovato.</td></tr>';
        } else {
          tableBody.innerHTML = "";
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const docId = doc.id;
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${data.FirstName || ""}</td>
              <td>${data.LastName || ""}</td>
              <td>${data.BirthYear || ""}</td>
              <td>${data.Phone || ""}</td>
              <td>${data.Email || "-"}</td>
              <td>
                <div class="action-icons">
                  <button class="edit-btn" title="Modifica">‚úèÔ∏è</button>
                  <button class="delete-btn" title="Elimina">üóëÔ∏è</button>
                </div>
              </td>
            `;
            tableBody.appendChild(row);

            // Attach event listeners
            row.querySelector('.edit-btn').onclick = () => editStudent(docId, row, data);
            row.querySelector('.delete-btn').onclick = () => deleteStudent(docId, row);
          });
        }
      })
      .catch((error) => {
        statusDiv.textContent = "‚ùå Errore connessione: " + error.message;
        statusDiv.style.color = "#f87171";
        tableBody.innerHTML = '<tr><td colspan="6">Errore nel caricamento degli iscritti.</td></tr>';
      });
  });
</script>
</body>
</html>